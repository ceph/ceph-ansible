---
- set_fact:
    ceph_authtool_cap: "--cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow' --cap mgr 'allow *'"
  when:
    - ceph_release_num.{{ ceph_release }} >= ceph_release_num.luminous
    - cephx
    - admin_secret != 'admin_secret'

- set_fact:
    ceph_authtool_cap: "--cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow'"
  when:
    - ceph_release_num.{{ ceph_release }} < ceph_release_num.luminous
    - cephx
    - admin_secret != 'admin_secret'

- name: create custom admin keyring
  command: "ceph-authtool /etc/ceph/{{ cluster }}.client.admin.keyring --create-keyring --name=client.admin --add-key={{ admin_secret }} --set-uid=0 {{ ceph_authtool_cap }}"
  args:
    creates: /etc/ceph/{{ cluster }}.client.admin.keyring
  when:
    - cephx
    - admin_secret != 'admin_secret'

- name: set ownership of admin keyring
  file:
    path: /etc/ceph/{{ cluster }}.client.admin.keyring
    state: file
    owner: 'ceph'
    group: 'ceph'
    mode: '0600'
  when:
    - cephx
    - admin_secret != 'admin_secret'

- name: copy ceph admin keyring
  copy:
    src: "{{ fetch_directory }}/{{ fsid }}/etc/ceph/{{ cluster }}.client.admin.keyring"
    dest: "/etc/ceph/"
    owner: "ceph"
    group: "ceph"
    mode: "0600"
  when:
    - cephx
    - admin_secret == 'admin_secret'

- name: check if global key exists in ceph_conf_overrides
  set_fact:
    global_in_ceph_conf_overrides: "{{ 'global' in ceph_conf_overrides }}"
