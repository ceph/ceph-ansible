---
- name: get client keys
  copy:
    dest: "{{Â item.source }}"
    content: "{{ item.content | b64decode }}"
  with_items:
    - "{{ hostvars[groups.get(mon_group_name, [])|last]['slurp_client_keys']['results'] }}"
  when:
    - not item.get('skipped', False)

- name: chmod key(s)
  file:
    path: "/etc/ceph/{{ cluster }}.{{ item.0.name }}.keyring"
    mode: "{{ item.0.mode|default(omit) }}" # if mode not in list, uses mode from ps umask
  with_together:
    - "{{ hostvars[groups.get(mon_group_name, [])[0]]['keys'] }}"
    - "{{ hostvars[groups.get(mon_group_name, [])[0]]['slurp_client_keys']['results'] }}"
  when:
    - not item.1.get('skipped', False)

- name: setfacl for key(s)
  acl:
    path: "/etc/ceph/{{ cluster }}.{{ item.0.name }}.keyring"
    entry: "{{ item.1 }}"
    state: present
  with_subelements:
    - "{{ hostvars[groups.get(mon_group_name, [])[0]]['keys'] }}"
    - acls
    - skip_missing: true
  when:
    - item.0 | length > 0
