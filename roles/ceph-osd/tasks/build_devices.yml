---
- name: set_fact temp_devices
  set_fact:
    temp_devices: "{{ collocated.devices }}"
  when:
    - "'collocated' in osd_scenarios"
    - osd_auto_discovery

- name: set_fact devices generate device list when osd_auto_discovery for collocated osds
  set_fact:
    temp_devices: "{{ temp_devices | default([]) + [ item.key | regex_replace('^', '/dev/') ] }}"
  with_dict: "{{ ansible_devices }}"
  when:
    - "'collocated' in osd_scenarios"
    - osd_auto_discovery
    - ansible_devices is defined
    - item.value.removable == "0"
    - item.value.sectors != "0"
    - item.value.partitions|count == 0
    - item.value.holders|count == 0
    - "'dm-' not in item.key"

- name: set_fact collocated.devices to temp_devices after processing
  set_fact:
    collocated: "{{ collocated | combine( {'devices': temp_devices} ) }}"
  when:
    - "'collocated' in osd_scenarios"
    - osd_auto_discovery

- name: set_fact temp_devices
  set_fact:
    temp_devices: "{{ non_collocated.devices }}"
  when:
    - "'non-collocated' in osd_scenarios"
    - osd_auto_discovery

- name: set_fact devices generate device list when osd_auto_discovery for non_collocated osds
  set_fact:
    temp_devices: "{{ temp_devices | default([]) + [ item.key | regex_replace('^', '/dev/') ] }}"
  with_dict: "{{ ansible_devices }}"
  when:
    - "'non-collocated' in osd_scenarios"
    - osd_auto_discovery
    - ansible_devices is defined
    - item.value.removable == "0"
    - item.value.sectors != "0"
    - item.value.partitions|count == 0
    - item.value.holders|count == 0
    - "'dm-' not in item.key"

- name: set_fact non_collocated.devices to temp_devices after processing
  set_fact:
    non_collocated: "{{ non_collocated | combine( {'devices': temp_devices} ) }}"
  when:
    - "'non-collocated' in osd_scenarios"
    - osd_auto_discovery

- name: resolve dedicated device link(s)
  command: readlink -f {{ item }}
  changed_when: false
  with_items: "{{ non_collocated.dedicated_devices }}"
  register: dedicated_devices_prepare_canonicalize
  when:
    - "'non-collocated' in osd_scenarios"
    - not osd_auto_discovery

- name: set_fact build dedicated_devices from resolved symlinks
  set_fact:
    dedicated_devices_tmp: "{{ dedicated_devices_tmp | default([]) + [ item.stdout ] }}"
  with_items: "{{ dedicated_devices_prepare_canonicalize.results }}"
  when:
    - "'non-collocated' in osd_scenarios"
    - not osd_auto_discovery

- name: set_fact build final dedicated_devices list
  set_fact:
    dedicated_devices_tmp: "{{ dedicated_devices_tmp | reject('search','/dev/disk') | list }}"
  when:
    - "'non-collocated' in osd_scenarios"
    - not osd_auto_discovery

- name: set_fact non_collocated.dedicated_devices to dedicated_devices_tmp
  set_fact:
    non_collocated: "{{ non_collocated | combine( {'dedicated_devices': dedicated_devices_tmp} ) }}"
  when:
    - "'non-collocated' in osd_scenarios"
    - not osd_auto_discovery
