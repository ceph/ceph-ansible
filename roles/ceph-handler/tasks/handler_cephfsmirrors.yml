---
- name: set _cephfsmirror_handler_called before restart
  set_fact:
    _cephfsmirror_handler_called: True

- name: restart ceph rbd mirror daemon(s)
  service:
    name: 'cephfs-mirror@{{ ansible_hostname }}'
    state: restarted
  when:
    - hostvars[item]['handler_cephfs_mirror_status'] | default(False) | bool
    - hostvars[item]['_cephfsmirror_handler_called'] | default(False) | bool
  with_items: "{{ groups[cephfsmirror_group_name] }}"
  delegate_to: "{{ item }}"
  run_once: True

- name: set _cephfsmirror_handler_called after restart
  set_fact:
    _cephfsmirror_handler_called: False
