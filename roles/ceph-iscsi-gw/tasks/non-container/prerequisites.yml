---
- name: Red hat based systems tasks
  when: ansible_facts['os_family'] == 'RedHat'
  block:
    - name: Set_fact common_pkgs
      ansible.builtin.set_fact:
        common_pkgs:
          - tcmu-runner
          - targetcli

    - name: Set_fact base iscsi pkgs if new style ceph-iscsi
      ansible.builtin.set_fact:
        iscsi_base:
          - ceph-iscsi
      when: use_new_ceph_iscsi | bool

    - name: Set_fact base iscsi pkgs if using older ceph-iscsi-config
      ansible.builtin.set_fact:
        iscsi_base:
          - ceph-iscsi-cli
          - ceph-iscsi-config
      when: not use_new_ceph_iscsi | bool

    - name: When ceph_iscsi_config_dev is true
      when:
        - ceph_origin == 'repository'
        - ceph_repository in ['dev', 'community']
        - ceph_iscsi_config_dev | bool
      block:
        - name: Ceph-iscsi dependency repositories
          ansible.builtin.get_url:
            url: "https://shaman.ceph.com/api/repos/tcmu-runner/main/latest/{{ ansible_facts['distribution'] | lower }}/{{ ansible_facts['distribution_major_version'] }}/repo?arch={{ ansible_facts['architecture'] }}"
            dest: '/etc/yum.repos.d/tcmu-runner-dev.repo'
            force: true
            mode: "0644"
          register: result
          until: result is succeeded

        - name: Ceph-iscsi development repository
          ansible.builtin.get_url:
            url: "https://shaman.ceph.com/api/repos/{{ item }}/main/latest/{{ ansible_facts['distribution'] | lower }}/{{ ansible_facts['distribution_major_version'] }}/repo"
            dest: '/etc/yum.repos.d/{{ item }}-dev.repo'
            force: true
            mode: "0644"
          register: result
          until: result is succeeded
          with_items: '{{ iscsi_base }}'
          when: ceph_repository == 'dev'

        - name: Ceph-iscsi stable repository
          ansible.builtin.get_url:
            url: "https://download.ceph.com/ceph-iscsi/{{ '3' if use_new_ceph_iscsi | bool else '2' }}/rpm/el{{ ansible_facts['distribution_major_version'] }}/ceph-iscsi.repo"
            dest: /etc/yum.repos.d/ceph-iscsi.repo
            force: true
            mode: "0644"
          register: result
          until: result is succeeded
          when: ceph_repository == 'community'

    - name: Install ceph iscsi package
      ansible.builtin.package:
        name: "{{ common_pkgs + iscsi_base }}"
        state: "{{ (upgrade_ceph_packages | bool) | ternary('latest', 'present') }}"
      register: result
      until: result is succeeded

- name: Check the status of the target.service override
  ansible.builtin.stat:
    path: /etc/systemd/system/target.service
  register: target

- name: Mask the target service - preventing manual start
  ansible.builtin.systemd:
    name: target
    masked: true
    enabled: false
  when:
    - target.stat.exists
    - not target.stat.islnk

# Only start tcmu-runner, so configure_iscsi.yml can create disks.
# We must start rbd-target-gw/api after configure_iscsi.yml to avoid
# races where they are both trying to setup the same object during
# a rolling update.
- name: Start tcmu-runner
  ansible.builtin.systemd:
    name: tcmu-runner
    state: started
    enabled: true
    masked: false
