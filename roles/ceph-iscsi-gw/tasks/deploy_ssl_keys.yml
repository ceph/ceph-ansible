---
- name: Create a temporary directory
  ansible.builtin.tempfile:
    state: directory
  register: iscsi_ssl_tmp_dir
  delegate_to: localhost
  run_once: true

- name: Set_fact crt_files
  ansible.builtin.set_fact:
    crt_files:
      - "iscsi-gateway.crt"
      - "iscsi-gateway.key"
      - "iscsi-gateway.pem"
      - "iscsi-gateway-pub.key"

- name: Check for existing crt file(s) in monitor key/value store
  ansible.builtin.command: "{{ container_exec_cmd }} ceph --cluster {{ cluster }} config get iscsi/ssl/{{ item }}"
  with_items: "{{ crt_files }}"
  changed_when: false
  failed_when: crt_files_exist.rc not in [0, 22]
  run_once: true
  delegate_to: "{{ groups.get(mon_group_name)[0] }}"
  register: crt_files_exist

- name: Set_fact crt_files_missing
  ansible.builtin.set_fact:
    crt_files_missing: "{{ crt_files_exist.results | selectattr('rc', 'equalto', 0) | map(attribute='rc') | list | length != crt_files | length }}"

- name: Generate ssl crt/key files
  when: crt_files_missing
  block:
    - name: Create ssl crt/key files
      ansible.builtin.command: >
        openssl req -newkey rsa:2048 -nodes -keyout {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway.key
         -x509 -days 365 -out {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway.crt
         -subj "/C=US/ST=./L=./O=RedHat/OU=Linux/CN={{ ansible_facts['hostname'] }}"
      delegate_to: localhost
      run_once: true
      changed_when: false
      with_items: "{{ crt_files_exist.results }}"

    - name: Create pem  # noqa: no-changed-when
      ansible.builtin.shell: >
        cat {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway.crt
        {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway.key > {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway.pem
      delegate_to: localhost
      run_once: true
      register: pem
      with_items: "{{ crt_files_exist.results }}"

    - name: Create public key from pem
      ansible.builtin.shell: >
        openssl x509 -inform pem -in {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway.pem
        -pubkey -noout > {{ iscsi_ssl_tmp_dir.path }}/iscsi-gateway-pub.key
      delegate_to: localhost
      run_once: true
      when: pem.changed
      tags: skip_ansible_lint

    - name: Slurp ssl crt/key files
      ansible.builtin.slurp:
        src: "{{ iscsi_ssl_tmp_dir.path }}/{{ item }}"
      register: iscsi_ssl_files_content
      with_items: "{{ crt_files }}"
      run_once: true
      delegate_to: localhost

    - name: Store ssl crt/key files
      ansible.builtin.command: "{{ container_exec_cmd }} ceph --cluster {{ cluster }} config-key put iscsi/ssl/{{ item.item }} {{ item.content }}"
      run_once: true
      delegate_to: "{{ groups.get(mon_group_name)[0] }}"
      with_items: "{{ iscsi_ssl_files_content.results }}"
      changed_when: false

- name: Copy crt file(s) to gateway nodes
  ansible.builtin.copy:
    content: "{{ item.stdout | b64decode }}"
    dest: "/etc/ceph/{{ item.item }}"
    owner: root
    group: root
    mode: "0400"
  changed_when: false
  with_items: "{{ crt_files_exist.results if not crt_files_missing else iscsi_ssl_files_content.results }}"
  when: not crt_files_missing

- name: Clean temporary directory
  ansible.builtin.file:
    path: "{{ iscsi_ssl_tmp_dir.path }}"
    state: absent
